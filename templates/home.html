{% extends "layout.html" %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <h2>Upload Audio File</h2>
        <form action="/transcribe_audio" method="POST" enctype="multipart/form-data">
            <input type="file" name="audio_file" accept=".mp3, .wav">
            <br>
            <button type="submit">Transcribe Audio</button>
        </form>
        <!-- Container for displaying transcription result -->
        <div id="transcription-result"></div>
    </div>

    <div class="col-md-4">
        <h2>Feedback for speech</h2>
        <button id="generate-response-btn1" type="button">Grammar</button>
        <br>
        <div id="gpt-response"></div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(function() {
        $("form").submit(function(e) {
            e.preventDefault(); // Prevent form submission

            // Show a loading message while waiting for transcription
            $("#transcription-result").html("Transcribing audio... Please wait.");

            // Serialize the form data
            var formData = new FormData(this);

            // Make an AJAX request to transcribe_audio route
            $.ajax({
                type: "POST",
                url: "/transcribe_audio",
                data: formData,
                contentType: false,
                processData: false,
                success: function(data) {
                    // Check for errors
                    if (data.error) {
                        $("#transcription-result").html("Error: " + data.error);
                    } else {
                        // Display the Whisper AI transcription
                        $("#transcription-result").html("Transcription: " + data.text);

                        // Enable the "Generate Response" button
                        $("#generate-response-btn1").prop("disabled", false);
                    }
                },
                error: function(xhr, status, error) {
                    $("#transcription-result").html("Error: " + error);
                }
            });
        });

        // Handle Generate Response button click
        $("#generate-response-btn1").click(function() {
            
            // Get the transcription text from the transcription result container
            var transcription = $("#transcription-result").text().replace("Transcription: ", "");

            // Show the loading message
            $("#gpt-response").html("Loading... Please wait.");

            generateResponse(transcription);
        });

        // Function to generate GPT-3.5 response
        function generateResponse(transcription) {
            // Make an AJAX request to send the transcription to the server
            $.ajax({
                type: "POST",
                url: "/generate_response",
                data: JSON.stringify({ transcription: transcription }),
                contentType: "application/json; charset=utf-8",
                success: function(data) {
                    // Display the GPT-3.5 response
                    $("#gpt-response").html("GPT-3.5 Response: " + data.response);
                },
                error: function(xhr, status, error) {
                    $("#gpt-response").html("Error: " + error);
                }
            });
        }
    });
</script>


{% endblock %}
